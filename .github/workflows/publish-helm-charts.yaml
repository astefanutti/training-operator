name: publish-helm-chart

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  pull_request:

env:
  CHART_PATH: charts/kubeflow-trainer

jobs:
  publish:
    permissions:
      contents: read
      packages: write

    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set appVersion
        id: set-version
        run: |
          # Determine appVersion based on ref type
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # For tags, use the tag name (e.g., v2.0.0)
            APP_VERSION="${GITHUB_REF#refs/tags/}"
          else
            # For master branch, use sha- prefix with short commit SHA
            APP_VERSION="sha-$(git rev-parse --short HEAD)"
          fi
          echo "APP_VERSION=${APP_VERSION}" >> $GITHUB_ENV
          echo "App version set to: ${APP_VERSION}"

      - name: Update appVersion in Chart.yaml
        run: |
          # Install yq if not available
          if ! command -v yq &> /dev/null; then
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
          fi
          yq eval ".appVersion = \"${{ env.APP_VERSION }}\"" -i ${{ env.CHART_PATH }}/Chart.yaml
          echo "Updated Chart.yaml with appVersion: ${{ env.APP_VERSION }}"

      - name: Set Helm chart version
        run: |
          VERSION=$(yq eval .version ${{ env.CHART_PATH }}/Chart.yaml)
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Helm dependency build
        run: helm dependency build
        working-directory: ${{ env.CHART_PATH }}

      - name: Package and push helm chart
        run: |
          CHART_NAME=$(yq eval .name ${{ env.CHART_PATH }}/Chart.yaml)
          helm package ${{ env.CHART_PATH }} --version ${{ env.VERSION }}
          helm push ./${CHART_NAME}-${{ env.VERSION }}.tgz oci://ghcr.io/kubeflow/charts/kubeflow-trainer
